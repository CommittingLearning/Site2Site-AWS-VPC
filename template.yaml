AWSTemplateFormatVersion: '2010-09-09'
Description: CloudFormation template to create a VPC with one subnet for an EC2 instance, named based on the environment.

Parameters:
  Environment:
    Type: String
    Description: "The environment name (e.g., development, production)"
    AllowedValues:
      - development
      - production
      - default
    
  VpcCIDR:
    Type: String
    Description: "The IP Address range of this VPC"
    Default: '192.168.0.0/16'
  
  EC2SubnetCIDR:
    Type: String
    Description: "The IP Address range of the subnet that hosts the EC2 instance."
    Default: '192.168.1.0/24'

  EC2SubnetAZ:
    Type: String
    Description: "Availability Zone of the EC2 Subnet"
    Default: 'us-west-2a'

  VGWId:
    Type: String
    Description: "The ID of the VPN Gateway (Called from the parent stack upon deployment)"

Resources:
  
  #Create VPC with dynamic name based on the environment
  MyVPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: !Ref VpcCIDR
      EnableDnsSupport: true
      EnableDnsHostnames: true
      Tags:
        - Key: Name
          Value: !Sub 'VPC_${Environment}'
        - Key: Environment
          Value: !Ref Environment 

  # Create a Subnet inside the VPC
  MySubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref MyVPC
      CidrBlock: !Ref EC2SubnetCIDR
      AvailabilityZone: !Ref EC2SubnetAZ
      Tags:
        - Key: Name
          Value: !Sub 'EC2Subnet_${Environment}'
        - Key: Environment
          Value: !Ref Environment

  # Create a Route Table for the Subnet
  RouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref MyVPC
      Tags:
        - Key: Name
          Value: !Sub 'RouteTable_${Environment}'

  # Add a Route to the VPN Gateway
  RouteToVGW:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref RouteTable
      DestinationCidrBlock: '0.0.0.0/0'
      GatewayId: !Ref VGWId

  # Associate Route Table to the EC2 Subnet
  SubnetRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref MySubnet
      RouteTableId: !Ref RouteTable

Outputs:
  VPCId:
    Description: 'The ID of the created VPC'
    Value: !Ref MyVPC
  SubnetId:
    Description: 'The ID of the created Subnet'
    Value: !Ref MySubnet